<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Local Log</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f6f6f6;
        --text: #111;
        --card: #fff;
        --muted: #6b7280;
        --border: #d1d5db;
        --header: #1f2937;
        --header-text: #fff;
        --accent: #2563eb;
        --accent-hover: #1d4ed8;
        --calendar-bg: rgba(15, 23, 42, 0.08);
        --calendar-dot: #2563eb;
      }
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      body.dark {
        color-scheme: dark;
        --bg: #0f172a;
        --text: #e2e8f0;
        --card: #111827;
        --muted: #94a3b8;
        --border: #334155;
        --header: #0b1220;
        --header-text: #e2e8f0;
        --accent: #60a5fa;
        --accent-hover: #3b82f6;
        --calendar-bg: rgba(148, 163, 184, 0.12);
        --calendar-dot: #60a5fa;
      }
      header {
        padding: 1.5rem;
        background: var(--header);
        color: var(--header-text);
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .topbar-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }
      .ghost-button {
        background: transparent;
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.35);
        border-radius: 999px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        cursor: pointer;
      }
      .ghost-button:hover {
        background: rgba(255, 255, 255, 0.15);
      }
      main {
        max-width: 900px;
        margin: 0 auto;
        padding: 1.5rem;
      }
      .card {
        background: var(--card);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
      }
      label {
        font-weight: 600;
      }
      input,
      textarea {
        width: 100%;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-top: 0.4rem;
        margin-bottom: 1rem;
        font: inherit;
        background: transparent;
        color: inherit;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover {
        background: var(--accent-hover);
      }
      .button-link {
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .button-danger {
        background: #dc2626;
      }
      .button-danger:hover {
        background: #b91c1c;
      }
      img {
        max-width: 100%;
        border-radius: 10px;
        margin: 0.8rem 0;
      }
      .comment {
        border-left: 3px solid #e5e7eb;
        margin-top: 0.6rem;
        padding-left: 0.8rem;
      }
      body.dark .comment {
        border-left-color: #334155;
      }
      .meta {
        color: var(--muted);
        font-size: 0.9rem;
      }
      dialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        width: min(640px, 90vw);
        background: var(--card);
        color: inherit;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      }
      dialog::backdrop {
        background: rgba(15, 23, 42, 0.6);
      }
      .calendar-modal {
        padding: 1.5rem;
      }
      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.5rem;
        text-align: center;
      }
      .calendar-day {
        position: relative;
        padding: 0.65rem 0.25rem;
        border-radius: 10px;
        background: var(--calendar-bg);
        font-weight: 600;
      }
      .calendar-day.outside {
        opacity: 0.45;
      }
      .calendar-day .dot {
        position: absolute;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--calendar-dot);
        left: 50%;
        bottom: 6px;
        transform: translateX(-50%);
      }
      .calendar-day.active {
        outline: 2px solid var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      }
      .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.5rem;
        text-align: center;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 0.5rem;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="topbar">
        <div>
          <h1>Local Log</h1>
          <p>Private blog for your local network.</p>
        </div>
        <div class="topbar-actions">
          <button class="ghost-button" id="calendar-button" type="button">Calendar</button>
          <button class="ghost-button" id="theme-toggle" type="button">Dark mode</button>
        </div>
      </div>
    </header>
    <main>
      {% if selected_date %}
      <section class="card">
        <p class="meta">
          Showing posts from <strong>{{ selected_date }}</strong>.
          <a class="button-link ghost-button" href="{{ url_for('index') }}">Clear filter</a>
        </p>
      </section>
      {% endif %}
      <section class="card">
        <h2>New post</h2>
        <form action="/post" method="post" enctype="multipart/form-data">
          <label for="title">Title</label>
          <input id="title" name="title" required />

          <label for="body">Body</label>
          <textarea id="body" name="body" rows="4" required></textarea>

          <label for="image">Photo (optional)</label>
          <input id="image" type="file" name="image" accept="image/*" />

          <button type="submit">Publish</button>
        </form>
      </section>

      {% for post in posts %}
      <article class="card">
        <h2>{{ post.title }}</h2>
        <p class="meta">Posted {{ post.created_at }}</p>
        <p>{{ post.body }}</p>
        {% if post.image_filename %}
        <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" alt="Post image" />
        {% endif %}
        <form action="/post/{{ post.id }}/delete" method="post" onsubmit="return confirm('Delete this post?');">
          <button class="button-danger" type="submit">Delete post</button>
        </form>

        <section>
          <h3>Comments</h3>
          {% if comments_by_post.get(post.id) %}
            {% for comment in comments_by_post[post.id] %}
            <div class="comment">
              <p><strong>{{ comment.author }}</strong> <span class="meta">{{ comment.created_at }}</span></p>
              <p>{{ comment.body }}</p>
            </div>
            {% endfor %}
          {% else %}
            <p class="meta">No comments yet.</p>
          {% endif %}
        </section>

        <form action="/comment/{{ post.id }}" method="post">
          <label for="author-{{ post.id }}">Name</label>
          <input id="author-{{ post.id }}" name="author" placeholder="Anonymous" />

          <label for="comment-{{ post.id }}">Comment</label>
          <textarea id="comment-{{ post.id }}" name="body" rows="2" required></textarea>

          <button type="submit">Add comment</button>
        </form>
      </article>
      {% endfor %}
    </main>

    <dialog id="calendar-dialog">
      <div class="calendar-modal">
        <div class="calendar-header">
          <div>
            <strong>Posting calendar</strong>
            <p class="meta" id="calendar-month-label"></p>
          </div>
          <button class="ghost-button" id="close-calendar" type="button">Close</button>
        </div>
        <div class="calendar-weekdays">
          <span>Sun</span>
          <span>Mon</span>
          <span>Tue</span>
          <span>Wed</span>
          <span>Thu</span>
          <span>Fri</span>
          <span>Sat</span>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
      </div>
    </dialog>

    <script>
      const body = document.body;
      const toggleButton = document.getElementById("theme-toggle");
      const calendarButton = document.getElementById("calendar-button");
      const calendarDialog = document.getElementById("calendar-dialog");
      const closeCalendar = document.getElementById("close-calendar");
      const monthLabel = document.getElementById("calendar-month-label");
      const calendarGrid = document.getElementById("calendar-grid");
      const postDates = new Set({{ post_dates | tojson }});
      const selectedDate = {{ selected_date | tojson }};

      const storedTheme = localStorage.getItem("theme");
      if (storedTheme === "dark") {
        body.classList.add("dark");
      }
      toggleButton.textContent = body.classList.contains("dark")
        ? "Light mode"
        : "Dark mode";

      toggleButton.addEventListener("click", () => {
        body.classList.toggle("dark");
        const isDark = body.classList.contains("dark");
        toggleButton.textContent = isDark ? "Light mode" : "Dark mode";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });

      const buildCalendar = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startOffset = firstDay.getDay();
        const totalDays = lastDay.getDate();
        const totalCells = Math.ceil((startOffset + totalDays) / 7) * 7;
        const monthFormatter = new Intl.DateTimeFormat("en-US", {
          month: "long",
          year: "numeric",
        });

        monthLabel.textContent = monthFormatter.format(firstDay);
        calendarGrid.innerHTML = "";

        for (let cell = 0; cell < totalCells; cell += 1) {
          const dayNumber = cell - startOffset + 1;
          const cellDate = new Date(year, month, dayNumber);
          const isOutside = dayNumber < 1 || dayNumber > totalDays;
          const dayEl = document.createElement("div");
          dayEl.className = `calendar-day${isOutside ? " outside" : ""}`;
          dayEl.textContent = cellDate.getDate();

          if (!isOutside) {
            const isoDate = cellDate.toISOString().slice(0, 10);
            if (selectedDate && isoDate === selectedDate) {
              dayEl.classList.add("active");
            }
            if (postDates.has(isoDate)) {
              const dot = document.createElement("span");
              dot.className = "dot";
              dayEl.appendChild(dot);
            }
            dayEl.addEventListener("click", () => {
              window.location = `/?date=${isoDate}`;
            });
          }
          calendarGrid.appendChild(dayEl);
        }
      };

      calendarButton.addEventListener("click", () => {
        buildCalendar();
        if (typeof calendarDialog.showModal === "function") {
          calendarDialog.showModal();
        } else {
          calendarDialog.setAttribute("open", "open");
        }
      });

      closeCalendar.addEventListener("click", () => {
        calendarDialog.close();
      });

      calendarDialog.addEventListener("click", (event) => {
        if (event.target === calendarDialog) {
          calendarDialog.close();
        }
      });
    </script>
  </body>
</html>
